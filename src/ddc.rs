#![allow(clippy::excessive_precision)]
use num::Complex;

pub use crate::{
    bindings::{self, fcomplex, DDCResources, DDCResources2},
    payload::N_PT_PER_FRAME,
};
use std::os::raw::c_int;

unsafe impl Send for fcomplex {}
unsafe impl Sync for fcomplex {}
pub const M: usize = 8192;

pub fn npt_ddc_per_dump(ndec: usize)->usize{
    N_PT_PER_FRAME * M / ndec
}


pub struct DownConverter(pub DDCResources);

impl DownConverter {
    pub fn new(ndec: usize, fir_coeffs: &[f32]) -> Self {
        let k = fir_coeffs.len() / ndec;
        assert_eq!(ndec * k, fir_coeffs.len());

        let mut res = DDCResources {
            d_indata: std::ptr::null_mut(),
            K: k as i32,
            N: N_PT_PER_FRAME as i32,
            M: M as i32,
            NDEC: ndec as i32,
            d_fir_coeffs: std::ptr::null_mut(),
            d_outdata: std::ptr::null_mut(),
            mixed_data: std::ptr::null_mut(),
            h_indata: std::ptr::null_mut(),
            h_index: 0,
        };
        unsafe {
            crate::bindings::init_ddc_resources(
                (&mut res) as *mut DDCResources,
                N_PT_PER_FRAME as i32,
                M as i32,
                ndec as c_int,
                k as c_int,
                fir_coeffs.as_ptr(),
            );
        }

        Self(res)
    }

    pub fn ddc(&mut self, indata: &[i16], lo_ch: isize) -> bool {
        assert_eq!(indata.len(), N_PT_PER_FRAME);

        let result = unsafe {
            bindings::ddc(
                indata.as_ptr(),
                lo_ch as c_int,
                (&mut self.0) as *mut DDCResources,
            )
        };
        assert!(result >= 0);
        result != 0
    }

    pub fn fetch_output(&mut self, outdata: &mut [Complex<f32>]) {
        assert_eq!(outdata.len(), self.n_out_data());
        unsafe {
            bindings::fetch_output(
                outdata.as_mut_ptr() as *mut fcomplex,
                (&mut self.0) as *mut DDCResources,
            )
        }
    }

    pub fn n_out_data(&self) -> usize {
        unsafe { bindings::calc_output_size((&self.0) as *const DDCResources) as usize }
    }
}

impl Drop for DownConverter {
    fn drop(&mut self) {
        unsafe { crate::bindings::free_ddc_resources((&mut self.0) as *mut DDCResources) };
    }
}

pub fn fir_coeffs_full() -> Vec<f32> {
    vec![ 6.511092736270887e-05,0.0002610800320873389,0.00017545736790609883,6.534990146025824e-06,-0.00013064224711429614,-4.2374320222136755e-05,0.00011846801025538272,9.381485009121802e-05,-9.410953142517377e-05,-0.00014759778005195786,4.2319431418274774e-05,0.0001881540799845698,3.630845107105931e-05,-0.0001990533818844084,-0.00013162560788419303,0.00016758149726144188,0.00022572137573968518,-8.849391271015337e-05,-0.00029594138462746126,-3.315357773057116e-05,0.00031945251703626506,0.00018082810931149146,-0.0002785162792775298,-0.00032776795854199195,0.00016599556555425577,0.0004409707544280599,1.077334945914077e-05,-0.0004873269280804832,-0.00022833012162899762,0.00044098944269782515,0.0004488022823825324,-0.00029090908022248746,-0.0006255202590798219,4.6156392238297665e-05,0.0007114298031486097,0.00026183258384369814,-0.0006692135467768927,-0.0005817459552709379,0.00048113851162962375,0.0008495978664086537,-0.00015656109223371843,-0.0009998640236476056,-0.0002648319332624878,0.000978659637860708,0.0007157942676828222,-0.0007574672076905588,-0.001110811462434928,0.00034287022760047563,0.0013587937421949412,0.0002160439878026451,-0.0013844988933647984,-0.0008348539783917363,0.001142456420439801,0.0014006924966443058,-0.0006334900392028569,-0.0017923133704108255,-8.799563483617462e-05,0.001902799507752816,0.0009163731835430942,-0.0016628472016176942,-0.0017076564959111603,0.0010609749494946861,0.0023013921613654815,-0.00015448328659046823,-0.002550114014900376,-0.000930512587170035,0.002349742292605048,0.0020133688297898295,-0.0016669315921951848,-0.0028854050458978677,0.0005559967402292598,0.0033459893032061656,0.0008379902900509128,-0.0032421675976144248,-0.002293353500579938,0.002505289200975526,0.0035428150286430653,-0.001176292151342157,-0.0043170410816730995,-0.0005855167960283796,0.004395167311127992,0.002514956263539614,-0.0036532608391771026,-0.00427466497791831,0.0021017255075512073,0.005506884461417718,9.668636368609807e-05,-0.005896277126299155,-0.002633992452319537,0.005233867188375215,0.005091231622657677,-0.00347061965776215,-0.006997100798846179,0.0007508224458822811,0.00790445083960876,0.0025848277235405804,-0.007471555467004083,-0.0060272573267219015,0.005538828926784138,0.00896109890815287,-0.0021840337940556274,-0.010751238986104502,-0.0022529935591437855,0.010843815475210954,0.00718304594292555,-0.008867336556415603,-0.011819032097783377,0.00471829444697636,0.015260421634791264,0.0013817394926450644,-0.01659828046567417,-0.008866489017257352,0.015023318065573592,0.016843234516820262,-0.009913039891405753,-0.024138116615502123,0.0008676748687987228,0.029337370693395325,0.012356516002259208,-0.030745831059823762,-0.03014057774976809,0.026022986875834438,0.053974319878763194,-0.010473309692309175,-0.09061577301013332,-0.03346732769190203,0.188753396740593,0.40106177681691507,0.40106177681691507,0.188753396740593,-0.03346732769190203,-0.09061577301013332,-0.010473309692309175,0.053974319878763194,0.026022986875834438,-0.03014057774976809,-0.030745831059823762,0.012356516002259208,0.029337370693395325,0.0008676748687987228,-0.024138116615502123,-0.009913039891405753,0.016843234516820262,0.015023318065573592,-0.008866489017257352,-0.01659828046567417,0.0013817394926450644,0.015260421634791264,0.00471829444697636,-0.011819032097783377,-0.008867336556415603,0.00718304594292555,0.010843815475210954,-0.0022529935591437855,-0.010751238986104502,-0.0021840337940556274,0.00896109890815287,0.005538828926784138,-0.0060272573267219015,-0.007471555467004083,0.0025848277235405804,0.00790445083960876,0.0007508224458822811,-0.006997100798846179,-0.00347061965776215,0.005091231622657677,0.005233867188375215,-0.002633992452319537,-0.005896277126299155,9.668636368609807e-05,0.005506884461417718,0.0021017255075512073,-0.00427466497791831,-0.0036532608391771026,0.002514956263539614,0.004395167311127992,-0.0005855167960283796,-0.0043170410816730995,-0.001176292151342157,0.0035428150286430653,0.002505289200975526,-0.002293353500579938,-0.0032421675976144248,0.0008379902900509128,0.0033459893032061656,0.0005559967402292598,-0.0028854050458978677,-0.0016669315921951848,0.0020133688297898295,0.002349742292605048,-0.000930512587170035,-0.002550114014900376,-0.00015448328659046823,0.0023013921613654815,0.0010609749494946861,-0.0017076564959111603,-0.0016628472016176942,0.0009163731835430942,0.001902799507752816,-8.799563483617462e-05,-0.0017923133704108255,-0.0006334900392028569,0.0014006924966443058,0.001142456420439801,-0.0008348539783917363,-0.0013844988933647984,0.0002160439878026451,0.0013587937421949412,0.00034287022760047563,-0.001110811462434928,-0.0007574672076905588,0.0007157942676828222,0.000978659637860708,-0.0002648319332624878,-0.0009998640236476056,-0.00015656109223371843,0.0008495978664086537,0.00048113851162962375,-0.0005817459552709379,-0.0006692135467768927,0.00026183258384369814,0.0007114298031486097,4.6156392238297665e-05,-0.0006255202590798219,-0.00029090908022248746,0.0004488022823825324,0.00044098944269782515,-0.00022833012162899762,-0.0004873269280804832,1.077334945914077e-05,0.0004409707544280599,0.00016599556555425577,-0.00032776795854199195,-0.0002785162792775298,0.00018082810931149146,0.00031945251703626506,-3.315357773057116e-05,-0.00029594138462746126,-8.849391271015337e-05,0.00022572137573968518,0.00016758149726144188,-0.00013162560788419303,-0.0001990533818844084,3.630845107105931e-05,0.0001881540799845698,4.2319431418274774e-05,-0.00014759778005195786,-9.410953142517377e-05,9.381485009121802e-05,0.00011846801025538272,-4.2374320222136755e-05,-0.00013064224711429614,6.534990146025824e-06,0.00017545736790609883,0.0002610800320873389,6.511092736270887e-05]
}

pub fn fir_coeffs_half() -> Vec<f32> {
    vec![
        -0.00011975709287684854,
        -5.358297155071411e-05,
        -1.1690992800869759e-05,
        6.318503319973864e-05,
        0.00014381767759789795,
        0.00019251243803779036,
        0.00017926123825758952,
        0.0001000818332442074,
        -1.6126375534177568e-05,
        -0.00011671308546651544,
        -0.00014909952823524274,
        -9.034462379991167e-05,
        3.719860657268353e-05,
        0.000170566958288551,
        0.00023529932246290294,
        0.00018466772072276056,
        2.9289445280800564e-05,
        -0.00016078909996314534,
        -0.00028663947125544454,
        -0.00027100487575933954,
        -0.00010429046250507815,
        0.00014168801171211316,
        0.0003422025862131671,
        0.0003818929142969262,
        0.00021907577064303474,
        -8.20382056371615e-05,
        -0.0003739779595254185,
        -0.0004966408861465735,
        -0.00036370505587745086,
        -1.8349981315456652e-05,
        0.0003755046269451075,
        0.0006091699582400865,
        0.0005381801198530545,
        0.00016824469265868942,
        -0.00033173749690819534,
        -0.0007042827114502241,
        -0.0007343147949394064,
        -0.0003705287895678264,
        0.0002298187938226951,
        0.0007654814578375737,
        0.0009402684616667222,
        0.0006245660962946229,
        -5.827137266615671e-05,
        -0.0007742445047035162,
        -0.0011398606227698196,
        -0.000925052977893023,
        -0.000192273355532753,
        0.0007104885738672611,
        0.0013117631764071364,
        0.0012604928520933167,
        0.0005264757962187468,
        -0.0005547766071170229,
        -0.00143121429911602,
        -0.0016133256205593033,
        -0.0009437708029966104,
        0.00028941647754240544,
        0.0014702889673182864,
        0.0019595087344616508,
        0.0014367577825835794,
        9.983855847577527e-05,
        -0.0013993654659085353,
        -0.0022685703222038293,
        -0.001990182205938592,
        -0.0006217411439447768,
        0.0011888043302356846,
        0.0025046053219223365,
        0.002580458661425593,
        0.001278464997496623,
        -0.0008103933130272807,
        -0.00262669503357579,
        -0.0031751380329187425,
        -0.00206371235014662,
        0.0002392870616855232,
        0.0025904634230410127,
        0.0037328902106388536,
        0.0029616867558883942,
        0.0005441309657401852,
        -0.0023494031777414204,
        -0.004204153775682432,
        -0.003946589834412276,
        -0.0015534843966052419,
        0.0018556489853696649,
        0.004531058865984813,
        0.00498208785424941,
        0.0027954541141162787,
        -0.0010604266066783173,
        -0.004647564872824069,
        -0.006021033196259746,
        -0.004270033615525379,
        -8.659196186510841e-05,
        0.0044784328013305124,
        0.007005460773925839,
        0.005972042854595251,
        0.001640644673802196,
        -0.003935936679510697,
        -0.00786546884930151,
        -0.00789450226503198,
        -0.003669051692058861,
        0.0029121108511674103,
        0.008516812127230794,
        0.010035760216213548,
        0.006267648757190845,
        -0.0012607753153357016,
        -0.008853463193199294,
        -0.012413388821774368,
        -0.009595983358553363,
        -0.0012437946545409014,
        0.008728187587486178,
        0.015092634373100638,
        0.013958188753522921,
        0.005006523800487536,
        -0.007902061594602107,
        -0.01825774081693717,
        -0.0200187999363573,
        -0.010892875756028547,
        0.0058913344027753094,
        0.022426795160134683,
        0.029510694968041637,
        0.021224826269884898,
        -0.001372348434706864,
        -0.02934264322933621,
        -0.0485474232353165,
        -0.04512094504838804,
        -0.011594716872094268,
        0.04895628136353434,
        0.12271541345547768,
        0.18927057841120407,
        0.22867097726040536,
        0.22867097726040536,
        0.18927057841120407,
        0.12271541345547768,
        0.04895628136353434,
        -0.011594716872094268,
        -0.04512094504838804,
        -0.0485474232353165,
        -0.02934264322933621,
        -0.001372348434706864,
        0.021224826269884898,
        0.029510694968041637,
        0.022426795160134683,
        0.0058913344027753094,
        -0.010892875756028547,
        -0.0200187999363573,
        -0.01825774081693717,
        -0.007902061594602107,
        0.005006523800487536,
        0.013958188753522921,
        0.015092634373100638,
        0.008728187587486178,
        -0.0012437946545409014,
        -0.009595983358553363,
        -0.012413388821774368,
        -0.008853463193199294,
        -0.0012607753153357016,
        0.006267648757190845,
        0.010035760216213548,
        0.008516812127230794,
        0.0029121108511674103,
        -0.003669051692058861,
        -0.00789450226503198,
        -0.00786546884930151,
        -0.003935936679510697,
        0.001640644673802196,
        0.005972042854595251,
        0.007005460773925839,
        0.0044784328013305124,
        -8.659196186510841e-05,
        -0.004270033615525379,
        -0.006021033196259746,
        -0.004647564872824069,
        -0.0010604266066783173,
        0.0027954541141162787,
        0.00498208785424941,
        0.004531058865984813,
        0.0018556489853696649,
        -0.0015534843966052419,
        -0.003946589834412276,
        -0.004204153775682432,
        -0.0023494031777414204,
        0.0005441309657401852,
        0.0029616867558883942,
        0.0037328902106388536,
        0.0025904634230410127,
        0.0002392870616855232,
        -0.00206371235014662,
        -0.0031751380329187425,
        -0.00262669503357579,
        -0.0008103933130272807,
        0.001278464997496623,
        0.002580458661425593,
        0.0025046053219223365,
        0.0011888043302356846,
        -0.0006217411439447768,
        -0.001990182205938592,
        -0.0022685703222038293,
        -0.0013993654659085353,
        9.983855847577527e-05,
        0.0014367577825835794,
        0.0019595087344616508,
        0.0014702889673182864,
        0.00028941647754240544,
        -0.0009437708029966104,
        -0.0016133256205593033,
        -0.00143121429911602,
        -0.0005547766071170229,
        0.0005264757962187468,
        0.0012604928520933167,
        0.0013117631764071364,
        0.0007104885738672611,
        -0.000192273355532753,
        -0.000925052977893023,
        -0.0011398606227698196,
        -0.0007742445047035162,
        -5.827137266615671e-05,
        0.0006245660962946229,
        0.0009402684616667222,
        0.0007654814578375737,
        0.0002298187938226951,
        -0.0003705287895678264,
        -0.0007343147949394064,
        -0.0007042827114502241,
        -0.00033173749690819534,
        0.00016824469265868942,
        0.0005381801198530545,
        0.0006091699582400865,
        0.0003755046269451075,
        -1.8349981315456652e-05,
        -0.00036370505587745086,
        -0.0004966408861465735,
        -0.0003739779595254185,
        -8.20382056371615e-05,
        0.00021907577064303474,
        0.0003818929142969262,
        0.0003422025862131671,
        0.00014168801171211316,
        -0.00010429046250507815,
        -0.00027100487575933954,
        -0.00028663947125544454,
        -0.00016078909996314534,
        2.9289445280800564e-05,
        0.00018466772072276056,
        0.00023529932246290294,
        0.000170566958288551,
        3.719860657268353e-05,
        -9.034462379991167e-05,
        -0.00014909952823524274,
        -0.00011671308546651544,
        -1.6126375534177568e-05,
        0.0001000818332442074,
        0.00017926123825758952,
        0.00019251243803779036,
        0.00014381767759789795,
        6.318503319973864e-05,
        -1.1690992800869759e-05,
        -5.358297155071411e-05,
        -0.00011975709287684854,
    ]
}

